<!DOCTYPE html>
<html lang="ja" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="encoding" content="utf-8">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <style>
      *, ::after, ::before {
  box-sizing: border-box;
}

:root { 
  --font-family-base: Arial, Helvetica, sans-serif;
  --text-color-primary: #6F6D6A;
  --bg-body: #E8F6FF;
  --fs-body: clamp(.9rem, 1.4vw, 1.2rem);
  --height-top-layout: 0;
}

body {
  --pb-body: 0;
  margin: 0;
  margin-top: var(--height-top-layout);
  height: calc(100vh - var(--height-top-layout));
  width: 100vw;
  line-height: 1.3;
  font-weight: 600;
  font-size: var(--fs-body);
  font-family: var(--font-family-base);
  color: var(--text-color-primary);
  background-color: var(--bg-body);
  overflow: hidden;
  position: relative;
  padding-bottom: var(--pb-body);
}

img {
  max-width: 100%;
}

.text-nowrap {
  white-space: nowrap;
}

.center {
  display: flex;
  justify-content: center;
  align-items: center;
}

.tutorial-path {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 0;
  width: 100%;
  height: 100%;
}

.tutorial {
  height: 100%;
  width: 100%;
  /* background: url('../images/tutorials/icon-default/line.svg') no-repeat center center; */
  max-width: 768px;
  padding-bottom: 0;
  margin-left: auto;
  margin-right: auto;
}

.tutorial-wrapper-inner {
  padding: 0px 10px;
  height: 100vh;
  max-height: 100%;
  width: 100vw;
  max-width: 100%;
  position: relative;
}

.tutorial-wrapper {
  display: flex;
  flex-direction: column-reverse;
  justify-content: space-between;
  width: 100%;
  height: 100%;
  gap: 5px;
}

.tutorial-action {
  flex: 1;
  display: flex;
  position: relative;
}

.tutorial-action--end {
  flex-direction: column-reverse;
  flex-grow: 0.8;
  justify-content: space-between;
  /* margin-top: 1rem; */
}

.tutorial-action--end[data-total-action="6"] {
 flex-grow: 1.4;
}

.tutorial-action--end[data-total-action="2"] {
 flex-grow: 1.4;
}

.tutorial-action--first {
  flex-grow: 1;
}

.tutorial-action--first.no-first-action {
   flex-grow: 1;
}

.tutorial-action-wrapper {
  display: flex;
  align-items: end;
  width: 100%;
}
.tutorial-action--first.no-first-action .tutorial-action-wrapper { 
  justify-content: left;
    margin-left: 12vw;
}

.tutorial-action:nth-child(2n) .tutorial-action-wrapper { 
 justify-content: end;
}

.tutorial-task {
  --bg-action: #FFFFFF;
  display: inline-block;
  border: 2px solid gray;
  border-radius: 20px;
  background-color: var(--bg-action);
  padding: 5px 8px;
  position: relative;
  min-width: 100px;
}

.tutorial-action--first .tutorial-task {
  margin-bottom: .7rem;
  margin-right: .5rem;
}

.tutorial-task-inner {
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: center;
}

.tutorial-action--first .tutorial-task-inner {
  min-height: 20px;
}

.tutorial-action--done .tutorial-text {
  color: #FCB040;
}

.task-icon {
  width: 25px;
  height: 25px;
  overflow: hidden;
}

.task-content {
  display: flex;
  flex-direction: column;

}

.title-action,
.sub-title-action {
  max-width: 62vw;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tutorial-task--first .title-action,
.tutorial-task--first .sub-title-action { 
  max-width: 33vw;
}

.checkmark-finished {
  position: absolute;
  width: clamp(1.2rem, 5vw, 1.6rem);
  height: clamp(1.2rem, 5vw, 1.6rem);
  right: -.3rem;
  top: -.6rem;
  z-index: 1;
  display: none;
}

.checkmark-inner {
  display: flex;
  align-items: center;
  gap: 5px;
}

.tutorial-action:nth-child(2n + 1) .checkmark-inner {
  flex-direction: row-reverse;
}

.checkmark-inner span { 
  color: #FCB040;
  display: inline-block;
}

.tutorial-animal {
  --image-size: 7vh;
  position: absolute;
  right: 0;
  top: calc(-1 * var(--image-size));
  width: var(--image-size);
  height: var(--image-size);
  display: flex;
  justify-content: center;
  align-items: end;
}
.tutorial-animal img {
  max-height: 100%;
}

.tutorial-action:nth-child(2n+1) .tutorial-animal {
  left: 7vw;
  right: auto;
  /* transform: rotateY(180deg); */
}

.tutorial-action:nth-child(4) .tutorial-animal[data-total-action="5"] {
  right: 15%;
}

/* .tutorial-action--end .tutorial-animal[data-total-action="4"],
.tutorial-action--end .tutorial-animal[data-total-action="6"] { 
  left: 12vw;
  right: auto;
  transform: rotateY(180deg);
} */
 /* .tutorial-animal img { 
  width: clamp(70px, 17vw, 90px);
  height: clamp(70px, 17vw, 90px);
} */


.tutorial-action:nth-child(2n) .checkmark-finished {
  left: -.3rem;
}

.tutorial-text {
  font-size: clamp(2rem, 12vw, 2.1rem);
  text-transform: uppercase;
  color: #6F7271;
}


.tutorial-action-footprint {
  position: absolute;
  width: 16vw;
  height: 14vw;
  max-width: 85px;
  max-height: 80px;
}


/*
* 7 action
*/
.tutorial-action-footprint--sixth img:first-child { 
  top: 0;
  left: 40%;
  transform: translateY(-40%);
}

.tutorial-action-footprint--sixth img:nth-child(2) { 
  bottom: 0;
  left: 0;
}


.tutorial-action-footprint[data-total-action="7"] {
  height: 6vh;
}

.decorative-image--second[data-total-action="7"] {
  top: 32%;
}

.use-android .decorative-image--second[data-total-action="7"] {
  top: 36%;
}

.tutorial-action-footprint--first[data-total-action="7"] {
  left: 44%;
  top: 0vw;
}

.tutorial-action-footprint--second[data-total-action="7"] { 
  left: 55%;
}

.tutorial-action-footprint--third[data-total-action="7"] { 
  left: 45%;
}

.tutorial-action-footprint--fourth[data-total-action="7"] { 
  left: 17%;
  height: 4vh;
  width: 14vw;
  top: 2vw
}
.tutorial-action-footprint--fifth[data-total-action="7"] { 
  left: 25%;
  height: 5vh;
  top: 1vw
}

.tutorial-action-footprint--sixth[data-total-action="7"] { 
  left: 45%;
  height: 4.5vh;
  top: 2vw;
  width: 10vw;
}

/* 6 action */
.tutorial-action-footprint[data-total-action="6"] {
  width: 16vw;
  height: 7vh;
}

.tutorial-action-footprint--first[data-total-action="6"] {
  left: 55%;
  top: 0vw;
  transform: translateX(-55%);
  height: 8vh;
}

.tutorial-action-footprint--second[data-total-action="6"] {
  left: 54%;
  top: 1vw;
  height: 5vh;
}

.tutorial-action-footprint--third[data-total-action="6"] {
  left: 30%;
  height: 4vh;
  top: 2vw;
}

.tutorial-action-footprint--fourth[data-total-action="6"] {
  left: 18%;
  top: 1vw;
  width: 11vw;
  height: 6vh;
}

.tutorial-action-footprint--fifth[data-total-action="6"] {
  left: 37%;
  top: 1vw;
  width: 13vw;
  height: 6vh;
}

.tutorial-action-footprint__inner {
  width: 100%;
  height: 100%;
  position: relative;
}

.tutorial-action-footprint img {
  --w-img-foot: clamp(1.2rem, 5vw, 1.5rem);
  position: absolute;
  width: var(--w-img-foot);
  max-width: 17px;
}

.tutorial-action-footprint--first img:first-child {
  right: 0;
}

.tutorial-action-footprint--first img:nth-child(2) {
  left: 10%;
  top: 50%;
  transform: translateY(-50%);
}

.tutorial-action-footprint--first img:nth-child(3) { 
  right: 0;
  bottom: 0;
}

.tutorial-action-footprint--second img:first-child { 
  bottom: 0;
}

.tutorial-action-footprint--second img:nth-child(2) { 
  right: 0;
  top: 0px;
}

.tutorial-action-footprint--third img:first-child { 
  top: 0px; 
  left: 0;
}

.tutorial-action-footprint--third img:nth-child(2) { 
  right: 0;
  bottom: 0;
}

.tutorial-action-footprint--fourth img:first-child { 
  top: 0px; 
  right: 0;
}

.tutorial-action-footprint--fourth img:nth-child(2) { 
  left: 0;
  bottom: 0;
}

.tutorial-action-footprint--fifth img:first-child { 
  top: 0;
  left: 40%;
  transform: translateY(-40%);
}

.tutorial-action-footprint--fifth img:nth-child(2) { 
  bottom: 0;
  left: 0;
}

/* 5 actions */
.tutorial-action-footprint--first[data-total-action="5"] {
  left: 50%;
  top: 3vw;
  height: 16vw;
}

.tutorial-action-footprint--second[data-total-action="5"] {
  left: 49%;
  top: 2vw;
  width: 10vw;
  height: 7vh;
}

.tutorial-action-footprint--third[data-total-action="5"] {
  left: 21%;
  height: 10vw;
  top: 3vw;
  width: 13vw;
}

.tutorial-action-footprint--fourth[data-total-action="5"] {
  left: 38%;
  top: 4vw;
  width: 12vw;
}

/* 4 actions */
.tutorial-action-footprint--first[data-total-action="4"] {
  left: 52%;
  top: 6vw;
  height: 16vw;
}

.tutorial-action-footprint--second[data-total-action="4"] {
  left: 35%;
  top: 12vw;
  width: 11vw;
  height: 12vw;
}

.tutorial-action-footprint--third[data-total-action="4"] {
  left: 30%;
  top: 2vw;
  width: 12vw;
  height: 11vw;
}

.tutorial-action-footprint--third[data-total-action="4"] img:first-child {
  top: 0;
  left: 100%;
  transform: translateY(-90%);
}

.tutorial-action-footprint--fifth[data-total-action="4"] img:nth-child(2) {
  bottom: 0;
  left: 0;
}

/* 3 actions */
.tutorial-action-footprint--first[data-total-action="3"] {
  left: 54%;
  top: 13vw;
  height: 16vw;
}

.tutorial-action-footprint--second[data-total-action="3"] {
  left: 23%;
  top: 10vw;
  width: 13vw;
}

.tutorial-action-footprint--first[data-total-action="2"] {
  left: 53%;
  top: 35%;
}

.tutorial-flag-end {
  display: flex;
  justify-content: end;
  align-items: center;
  margin-bottom: .5rem;
}

.img-flag {
  width: clamp(50px, 13vw, 100px);
  height: clamp(50px, 13vw, 100px);
}

.tutorial-action--done .tutorial-task {
  border: 2px solid #EDEDBE;
  background-color: #FDFCDF;
}

.tutorial-action-footprint .finished {
  display: none;
}

.tutorial-action--done .tutorial-action-footprint .unfinished {
  display: none;
}

.tutorial-action--done .tutorial-action-footprint .finished { 
   display: block;
}

.tutorial-action--done .checkmark-finished {
  display: block;
}

.tutorial-action-footprint-inner {
  width: 100%;
  height: 100%;
}

.tutorial-action-footprint-inner.direction-right{ 
  transform: rotate(18deg);
}

.tutorial-action-footprint-inner.direction-left{ 
  transform: rotate(-18deg);
}

.decorative-image {
  position: absolute;
  width: clamp(45px, 8vw, 100px);
  /* height: 50px; */
  top: 45vh;
}

.decorative-image--first[data-total-action="7"] {
  top: 45%;
}

.use-android .decorative-image--first[data-total-action="7"] { 
  top: 48%;
}

.decorative-image--first[data-total-action="6"] {
  top: 41vh
}

.decorative-image--first[data-total-action="4"] {
  top: 52vh;
}
.decorative-image--first[data-total-action="5"] {
  top: 32vh;
}


.decorative-image--second {
  top: 23%;
  right: 2vw;
}

.decorative-image--second[data-total-action="5"] {
  top: 13vh;
} 

.decorative-image--second[data-total-action="4"] { 
  top: 25vh;
}

/* @media only screen and (max-height: 678px) { 
  .tutorial-action:nth-child(2n+1) .tutorial-animal {
    left: 4vw;
  }
  .decorative-image--first {
    top: 35%;
  }

  .decorative-image--first[data-total-action="5"] { 
    top: 65%;
  }

  .decorative-image--second  {
    top: 20%;
  }
} */

@media only screen and (min-width: 567.98px) {
  :root { 
    --fs-body: clamp(1rem, 1.5vw, 1.3rem);
  }

  .checkmark-finished {
    top: -.7rem;
  }

  .tutorial-animal {
    --image-size: 90px;
  }

  .tutorial-text {
    font-size: clamp(2rem, 12vw, 2.6em);
  }

  /*
  * 7 Actions
  */
  .tutorial-action-footprint--sixth[data-total-action="7"] {
    left: 43vw;
  }

  .tutorial-action-footprint--fifth[data-total-action="7"] {
    left: 32vw;
  }

  .tutorial-action-footprint--fourth[data-total-action="7"] {
    left: 28vw;
    width: 10vw;
  }

  /* 6 actions */
  .tutorial-action-footprint[data-total-action="6"] {
    width: 16vw;
  }

  .tutorial-action-footprint--first[data-total-action="6"] {
    left: 52%;
    transform: translateX(-52%);
    top: 2vw;
  }

  .tutorial-action-footprint--second[data-total-action="6"] {
    left: 62%;
    transform: translateX(-62%);
  }

  .tutorial-action-footprint--third[data-total-action="6"] {
    left: 40%;
    transform: translateX(-40%);
  }

  .tutorial-action-footprint--fourth[data-total-action="6"] {
    left: 27%;
    width: 10vw;
  }

  .tutorial-action-footprint--fifth[data-total-action="6"] {
    top: 0vw;
    width: 8vw;
  }

  .tutorial-action-footprint--second[data-total-action="5"] {
    left: 50%;
    width: 11vw;
  }

  .tutorial-action-footprint--third[data-total-action="5"] {
    height: 7vw;
    left: 30%;
  }

  .tutorial-action-footprint--fourth[data-total-action="5"] {
    width: 7vw;
    top: 0;
    left: 42%;
  }

  .tutorial-action-footprint--second[data-total-action="4"] {
    left: 37%;
    width: 11vw;
    height: 7vw;
  }

  .tutorial-action-footprint--third[data-total-action="4"] {
    left: 28%;
  }

  .tutorial-action-footprint--first[data-total-action="3"] {
    left: 52%;
  }

  .tutorial-action-footprint--second[data-total-action="3"] {
    left: 28%;
    width: 9vw;
  }
}

@media only screen and (max-width: 420px) and (max-height: 780px) {
  /* 6 Action */
  .tutorial-action-footprint--fourth[data-total-action="6"] {
    left: 22%;
    top: -1vw;
  }

  .tutorial-action-footprint--third[data-total-action="6"] {
    left: 34%;
    height: 5vh;
  }

  .tutorial-action-footprint--second[data-total-action="6"] {
    top: 2vw;
    height: 4vh;
  }

  .tutorial-action-footprint--first[data-total-action="6"] {
    height: 7vh;
    left: 53%;
  }
  /* 4 Action */
  .tutorial-action-footprint--second[data-total-action="4"] {
    left: 41%;
    height: 11vw;
  }
}

@media only screen and (max-width: 380px) and (max-height: 670px) { 
  :root { 
    --fs-body: clamp(.8rem, 1.2vw, 1.1rem);
  }

  .tutorial-text {
    font-size: clamp(1.7rem, 10vw, 1.9rem);
  }

  .tutorial-task {
    padding: 4px 7px;
  }

  .img-flag {
    height: clamp(40px, 11vw, 80px);
    width: clamp(40px, 11vw, 80px);
  }

  .tutorial-action-footprint img {
    --w-img-foot: clamp(.9rem, 3.5vw, 1.2rem);
  }

  .checkmark-finished img {
    width: 17px;
  }

  /* 7 actions */
  .decorative-image--first[data-total-action="7"] {
    top: 47%;
  }

  .decorative-image--second[data-total-action="7"] {
    top: 33%
  }

  .tutorial-action-footprint[data-total-action="7"]{
    width: 13vw;
  }

  .tutorial-action-footprint--first[data-total-action="7"] {
    top: -2vw
  }

  .tutorial-action-footprint--second[data-total-action="7"] {
    top: -2vw
  }

  .tutorial-action-footprint--third[data-total-action="7"] {
    height: 5vh;
  }

  .tutorial-action-footprint--fourth[data-total-action="7"] {
    left: 20%;
    width: 13vw;
    top: 0vw;
    height: 3vh;
  }

  .tutorial-action-footprint--fifth[data-total-action="7"] {
    width: 10vw;
    left: 27%;
    top: 0;
  }

  .tutorial-action-footprint--sixth[data-total-action="7"] {
    top: 0;
  }
  

  /* 6 actions */
  .decorative-image--first[data-total-action="6"] {
    top: 40vh;
  }

  .tutorial-action-footprint[data-total-action="6"] {
    height: 6vh;
  }

  .tutorial-action-footprint--fifth[data-total-action="6"] {
    left: 40%;
  }

  .tutorial-action-footprint--fourth[data-total-action="6"] {
    left: 22%;
  }

  .tutorial-action-footprint--third[data-total-action="6"] {
    top: 2vw;
    left: 33%;
  }

  .tutorial-action-footprint--second[data-total-action="6"] {
    left: 53%;
    top: 2vw;
    height: 4vh;
  }

  /* 5 actions */
  .tutorial-action-footprint--fourth[data-total-action="5"] {
    left: 37%;
    height: 12vw;
    top: 2vw;
    width: 10vw;
  }

  .tutorial-action-footprint--third[data-total-action="5"] {
    left: 24%;
    height: 7vw;
  }

  .tutorial-action-footprint--second[data-total-action="5"] { 
    left: 52%;
    height: 9vw;
  }

  .tutorial-action-footprint--first[data-total-action="5"] {
    left: 46%;
  }

  .tutorial-action-footprint--second[data-total-action="4"] { 
    left: 39%;
    height: 9vw;
  }

  .tutorial-action-footprint--first[data-total-action="4"] {
    left: 49%;
  }
}
    </style>
  </head>
  <body>
    <svg xmlns="http://www.w3.org/2000/svg" class="tutorial-path" id="Layer_1" data-name="Layer 1" viewBox="0 0 1242 2688">
      <defs>
        <style>
          .cls-1 {
            fill: #fff;
          }
        </style>
      </defs>
      <path id="path-line" class="cls-1" d="M795.76,1537.12c-330.24-208.21-492.71-318.26-333.63-622.27,159.07-304.01,263.09-458.43,263.09-458.43l154.71-254.13h-122.58l-186.22,254.13-258.68,366.84s-369.25,436.49-36.07,685.85c333.18,249.35,384.28,265.96,369.25,460.91-18.88,244.77-372.75,690.68-372.75,690.68h462.86l192.2-492.39h-.11s198.18-422.99-132.05-631.19Z"/>
    </svg>
    <script type="text/javascript">
(function() {
 /**
 * Creates a DOM element with specified attributes, styles, and event listeners.
 * @param {string} tag - The HTML tag name.
 * @param {Object} options - Configuration for class, content, events, styles, and attributes.
 * @returns {HTMLElement} The created DOM element.
 */
function createElement(tag, { className, textContent, innerHTML, events = {}, style = {}, ...attributes }) {
    const element = document.createElement(tag);

    if (className) element.className = className;
    if (innerHTML !== undefined) {
        element.innerHTML = innerHTML;
    } else if (textContent !== undefined) {
        element.textContent = textContent;
    }

    Object.entries(attributes).forEach(([key, value]) => {
        if (value !== undefined && value !== null) {
            element.setAttribute(key, value);
        }
    });

    Object.entries(events).forEach(([event, handler]) => {
        if (typeof handler === 'function') {
            element.addEventListener(event, handler);
        }
    });

    Object.entries(style).forEach(([key, value]) => {
        if (value !== undefined && value !== null) {
            element.style[key] = value;
        }
    });

    return element;
}

/**
 * Tutorial class for managing an interactive tutorial UI.
 */
class Tutorial {
    #container = null;
    #course = {};
    #actions = [];
    #steps = [];
    #domReferences = {
        wrapper: null,
        wrapperInner: null,
        actionElements: new Map(),
        firstImg: null,
        secondImg: null,
    };
    #resolution = null;
    #heightTopLayout = null;
    #type = null;
    #animal_icons = [];
    #padding_bottom = false;
    #hasValidFirstAction = false;

    #footprintDirectionsMap = {
      7: ['right', 'right', 'left', 'left', 'right', 'right'],
      6: ['right', 'left', 'left', 'right', 'right'],
      5: ['right', 'left', 'right', 'right'],
      4: ['right', 'left', 'right'],
      3: ['right', 'right'],
      2: ['right']
    };

    // Number to word conversion for steps
    #numberWords = ['first', 'second', 'third', 'fourth', 'fifth', 'sixth'];

    /**
     * Initializes the tutorial with provided data.
     * @param {Object|string} dataInit - Initial data or JSON string.
     * @throws {Error} If data is invalid or parsing fails.
     */
    init(dataInit) {
        try {
            const parsedData = typeof dataInit === 'string' ? JSON.parse(dataInit) : dataInit;
            if (!parsedData || typeof parsedData !== 'object') {
                throw new Error('dataInit must be a valid object or JSON string');
            }

            const { data = {}, resolution, height_top_layout, type, padding_bottom } = parsedData;
            this.#resolution = resolution ?? null;
            this.#heightTopLayout = height_top_layout ?? null;
            this.#type = type;
            this.#padding_bottom = padding_bottom ?? false;
            this.#validateInitData(data);
            this.#animal_icons = data?.animal_icons ?? [1, 2]
            const courseChanged = this.#extractCourseData(data);
            const actions = this.#prepareActions(data);
            const actionChanged = this.#cloneActions(actions);
            this.#updateSteps();
            this.#render(courseChanged, actionChanged);

            const setPreviousResult = this.#setPreviousActionsFinished();
            return setPreviousResult;
        } catch (error) {
            throw new Error(`Initialization failed: ${error.message}`);
        }
    }

    /**
     * Prepares actions array, including first action if valid.
     * @private
     * @param {Object} data - Input data containing actions and first_action.
     * @returns {Array} Prepared actions array.
     */
    #prepareActions(data) {
        let actions = data.actions || [];
        this.#hasValidFirstAction = this.#isValidAction(data.first_action);
        if (this.#hasValidFirstAction) {
            const firstAction = {
                ...data.first_action,
                internalId: `${data.first_action.id}_first`,
                order: 0,
                tasks: [],
                icon: data.first_action.icon || null,
                sub_title: data.first_action.sub_title || null,
                bg_color: data.first_action.bg_color || '#ffffff',
                finished: data.first_action.finished ?? false,
                is_first_action: true
            };
            actions = [firstAction, ...actions.map(action => ({
                ...action,
                order: action.order + 1,
                internalId: action.id,
                is_first_action: false
            }))];
        } else {
            actions = [
                {
                    id: 'dummy_start',
                    internalId: 'dummy_start',
                    title: '',
                    order: 0,
                    tasks: [],
                    finished: true,
                    is_first_action: false,
                    bg_color: '#ffffff',
                    is_dummy: true
                },
                ...actions.map(action => ({
                    ...action,
                    order: action.order + 1,
                    internalId: action.id,
                    is_first_action: false
                }))
            ]
            //actions = actions.map(action => ({ ...action, internalId: action.id, is_first_action: false }));
        }
        return actions;
    }

    /**
     * Validates initialization data.
     * @private
     * @param {Object} data - Input data to validate.
     * @throws {Error} If validation fails.
     */
    #validateInitData(data) {
        if (!data?.actions?.length) {
            throw new Error('Invalid or missing actions data');
        }
    }

    /**
     * Extracts and updates course data.
     * @private
     * @param {Object} data - Input course data.
     * @returns {boolean} Whether course data changed.
     */
    #extractCourseData({ id, bg_color, illustration, illus_assets }) {
        const newCourse = { id, bg_color, illustration, illus_assets };
        const changed = JSON.stringify(this.#course) !== JSON.stringify(newCourse);
        this.#course = newCourse;
        return changed;
    }

    /**
     * Clones actions and detects changes.
     * @private
     * @param {Array} actions - List of actions to clone.
     * @returns {Object} Change information.
     */
    #cloneActions(actions) {
        const newActions = structuredClone(actions).sort((a, b) => a.order - b.order);
        const changedActionIds = new Set();
        let changed = false;
        let orderChanged = false;

        if (this.#actions.length !== newActions.length) {
            changed = true;
            orderChanged = true;
            newActions.forEach(a => changedActionIds.add(a.id));
        } else {
            newActions.forEach((newAction, i) => {
                const oldAction = this.#actions[i];
                if (!oldAction || JSON.stringify(oldAction) !== JSON.stringify(newAction)) {
                    changed = true;
                    changedActionIds.add(newAction.id);
                    if (oldAction?.id !== newAction.id) {
                        orderChanged = true;
                    }
                }
            });
        }

        this.#actions = newActions;
        return { changed, changedActionIds, orderChanged };
    }

    /**
     * Updates steps for rendering.
     * @private
     */
    #updateSteps() {
        const footprintDirections = this.#getFootprintDirections();
        const nextActionIndex = this.#findNextActionIndex();
        this.#steps = this.#actions.map((action, index) =>
            this.#createStep(action, index, footprintDirections, nextActionIndex)
        );
    }

    /**
     * Creates a step configuration.
     * @private
     * @param {Object} action - Action data.
     * @param {number} index - Step index.
     * @param {string[]} footprintDirections - Directions for footprints.
     * @param {number} nextActionIndex - Index of next action.
     * @returns {Object} Step configuration.
     */
    #createStep(action, index, footprintDirections, nextActionIndex) {
        const isFirst = index === 0;
        const isLast = index === this.#actions.length - 1;
        const isCompleted = action.finished ?? false;
        const isDummy = action.is_dummy;

        // Define possible animal images for the 7th action
        const randomAnimalImages = ['1.png', '3.png', '5.png'];
        let animalImage;
        if (this.#actions.length === 7 && index === 6 && !action.is_dummy) { 
            const randomIndex = Math.floor(Math.random() * randomAnimalImages.length);
            animalImage = `${this.#course.illus_assets}${this.#course.illustration}/animals/${randomAnimalImages[randomIndex]}`;
        } else {
           animalImage = action.is_dummy ? '' : `${this.#course.illus_assets}${this.#course.illustration}/animals/${index + 1}.png`; 
        }
        return {
            className: this.#getStepClassName(isFirst, isLast, isCompleted, isDummy),
            action: {
                icon: action.icon,
                title: action.title,
                sub_title: action.sub_title,
                bg_color: action.bg_color,
                animal: animalImage,
                animalVisible: index === nextActionIndex && !action.is_dummy,
                actionId: action.internalId,
                is_dummy: action.is_dummy || false
            },
            footer: this.#createFooter(isLast, isCompleted, index, footprintDirections),
            text: isFirst ? 'Start' : undefined,
            title: action.title,
            bg_color: action.bg_color,
            completed: isCompleted,
            isFirst,
            includeTask: !action.is_dummy
        };
    }

    /**
     * Creates footer configuration for a step.
     * @private
     * @param {boolean} isLast - Whether this is the last step.
     * @param {boolean} isCompleted - Whether the step is completed.
     * @param {number} index - Step index.
     * @param {string[]} footprintDirections - Footprint directions.
     * @returns {Object} Footer configuration.
     */
    #createFooter(isLast, isCompleted, index, footprintDirections) {
        if (isLast) {
            return {
                type: 'flag',
                src: isCompleted
                    ? `${this.#course.illus_assets}icon-default/icon-flag-finished.png`
                    : `${this.#course.illus_assets}icon-default/icon-flag.png`,
                text: 'GOAL'
            };
        }

        return {
            type: 'footprint',
            className: `tutorial-action-footprint--${this.#numberToWord(index + 1)}`,
            foot: {
                count: index === 0 ? 3 : 2,
                src: `${this.#course.illus_assets}${this.#course.illustration}/footprints/left_${isCompleted ? 'dark' : 'light'}.png`,
                direction: footprintDirections[index] || 'right'
            }
        };
    }

    /**
     * Converts number to word representation.
     * @private
     * @param {number} num - Number to convert.
     * @returns {string} Word representation.
     */
    #numberToWord(num) {
        return this.#numberWords[num - 1] || `step${num}`;
    }

    /**
     * Gets footprint directions for steps.
     * @private
     * @returns {string[]} Array of directions.
     */
    #getFootprintDirections() {
        return this.#footprintDirectionsMap[this.#actions.length] || [];
    }

    /**
     * Finds the index of the next action to be completed.
     * @private
     * @returns {number} Index of the next action.
     */
    #findNextActionIndex() {
        const finishedActions = this.#actions
            .filter(action => action.finished && !action.is_dummy)
            .sort((a, b) => b.order - a.order);

        if (!finishedActions.length) {
            const minOrderAction = this.#actions
                .filter(action => !action.is_dummy)
                .sort((a, b) => a.order - b.order)[0];
            return this.#actions.findIndex(action => action.order === minOrderAction.order);
        }

        const maxOrder = finishedActions[0].order;
        const nextAction = this.#actions
            .filter(action => !action.finished && !action.is_dummy && action.order > maxOrder)
            .sort((a, b) => a.order - b.order)[0];

        return nextAction
            ? this.#actions.findIndex(action => action.order === nextAction.order)
            : this.#actions.length;
    }

    /**
     * Generates CSS class names for a step.
     * @private
     * @param {boolean} isFirst - Is first step.
     * @param {boolean} isLast - Is last step.
     * @param {boolean} isCompleted - Is step completed.
     * @returns {string} Class names.
     */
    #getStepClassName(isFirst, isLast, isCompleted, isDummy) {
        return [
            'tutorial-action',
            isFirst && 'tutorial-action--first',
            isLast && 'tutorial-action--end',
            isCompleted && 'tutorial-action--done',
            isDummy && 'no-first-action'
        ].filter(Boolean).join(' ');
    }

    /**
     * Sets finished status for previous actions.
     * @private
     * @returns {Object} Result with updated action IDs.
     */
    #setPreviousActionsFinished() {
        const finishedActions = this.#actions
            .filter(action => action.finished && !action.is_dummy)
            .sort((a, b) => b.order - a.order);

        if (!finishedActions.length) {
            return { updatedActionIds: [] };
        }

        const maxOrder = finishedActions[0].order;
        const changedActionIds = new Set();

        this.#actions.forEach(action => {
            if (action.order < maxOrder && !action.finished  && !action.is_dummy) {
                action.finished = true;
                changedActionIds.add(action.id);
            }
        });

        if (changedActionIds.size > 0) {
            this.#updateSteps();
            this.#updateUI(false, { changed: true, changedActionIds, orderChanged: false });
        }

        return { updatedActionIds: Array.from(changedActionIds) };
    }

    /**
     * Updates the UI based on changes.
     * @private
     * @param {boolean} courseChanged - Whether course data changed.
     * @param {Object} actionChangeInfo - Action change information.
     */
    #updateUI(courseChanged, { changed, changedActionIds, orderChanged }) {
        if (courseChanged) {
            this.#updateCourseStyles();
        }
        if (changed) {
            this.#updateActionElements(changedActionIds, orderChanged);
        }
    }

    /**
     * Updates course-related styles.
     * @private
     */
    #updateCourseStyles() {
        document.body.style.setProperty('--bg-body', this.#course.bg_color);
    }

    /**
     * Updates action elements in the UI.
     * @private
     * @param {Set} changedActionIds - IDs of changed actions.
     * @param {boolean} orderChanged - Whether action order changed.
     */
    #updateActionElements(changedActionIds, orderChanged) {
        if (orderChanged || this.#domReferences.actionElements.size !== this.#steps.length) {
            this.#domReferences.wrapper.innerHTML = '';
            this.#domReferences.actionElements.clear();
            this.#steps.forEach((step, index) => {
                const actionElement = this.#createActionElement(step, index);
                this.#domReferences.actionElements.set(step.action.actionId, actionElement);
                this.#domReferences.wrapper.appendChild(actionElement);
            });
        } else {
            this.#steps.forEach((step, index) => {
                const actionId = step.action.actionId;
                const action = this.#actions.find(a => a.internalId === actionId);
                if (!action) return;

                const shouldUpdate = changedActionIds.has(action.id) || !this.#domReferences.actionElements.has(actionId);
                
                if (shouldUpdate) {
                    let actionElement = this.#domReferences.actionElements.get(actionId);
                    if (!actionElement) {
                        actionElement = this.#createActionElement(step, index);
                        this.#domReferences.actionElements.set(actionId, actionElement);
                        const currentElements = Array.from(this.#domReferences.wrapper.children);
                        if (index < currentElements.length) {
                            this.#domReferences.wrapper.insertBefore(actionElement, currentElements[index]);
                        } else {
                            this.#domReferences.wrapper.appendChild(actionElement);
                        }
                    } else {
                        this.#updateActionElement(actionElement, step);
                    }
                }
            });

            const currentActionIds = new Set(this.#steps.map(step => step.action.actionId));
            this.#domReferences.actionElements.forEach((element, id) => {
                if (!currentActionIds.has(id)) {
                    element.remove();
                    this.#domReferences.actionElements.delete(id);
                }
            });
        }
    }

    /**
     * Updates a single action element.
     * @private
     * @param {HTMLElement} element - Element to update.
     * @param {Object} step - Step configuration.
     */
    #updateActionElement(element, step) {
        const { task, taskIcon, titleAction, subTitleAction, animal, actionWrapper, textElement, footprint } = this.#cacheDomReferences(element);
        if (element.className !== step.className) element.className = step.className;
        task.classList.toggle('tutorial-task--done', step.completed);
        if (taskIcon && taskIcon.src !== step.action.icon) taskIcon.src = step.action.icon;
        if (titleAction && titleAction.innerHTML !== step.action.title) titleAction.innerHTML = step.action.title;
        if (subTitleAction && subTitleAction.innerHTML !== (step.action.sub_title ?? '')) subTitleAction.innerHTML = step.action.sub_title ?? '';

        if (animal) {
            animal.style.display = step.action.animalVisible ? 'flex' : 'none';
            const animals = document.querySelectorAll('.tutorial-animal');
            const nextActionIndex = this.#findNextActionIndex();
            animals.forEach((el, idx) => {
                const adjustedIndex = this.#hasValidFirstAction ? idx : idx + 1;
                el.style.display = adjustedIndex === nextActionIndex && !this.#steps[adjustedIndex].action.is_dummy ? 'flex' : 'none';
            });
        }

  
        if ((step.text && !step.includeTask) || step.isFirst) {
            if (!textElement) {
                actionWrapper.appendChild(createElement('div', { className: 'tutorial-text', textContent: step.text }));
            } else if (textElement.textContent !== step.text) {
                textElement.textContent = step.text;
            }
        } else if (textElement) {
            textElement.remove();
        }

        if (footprint && step.footer.type === 'footprint') {
            const footprintInner = footprint.querySelector('.tutorial-action-footprint-inner');
            const newClassName = `tutorial-action-footprint-inner ${step.completed ? 'finished' : 'unfinished'} direction-${step.footer.foot.direction}`;
            if (footprintInner.className !== newClassName) {
                footprintInner.className = newClassName;
            }
            footprintInner.querySelectorAll('img').forEach(img => {
                if (img.src !== step.footer.foot.src) img.src = step.footer.foot.src;
            });
        } else if (footprint && step.footer.type === 'flag') {
            const flagImg = footprint.querySelector('.img-flag img');
            if (flagImg.src !== step.footer.src) flagImg.src = step.footer.src;
            let flagText = footprint.querySelector('.tutorial-text');
            if (step.footer.text) {
                if (!flagText) {
                    flagText = createElement('div', { className: 'tutorial-text', textContent: step.footer.text });
                    footprint.appendChild(flagText);
                } else if (flagText.textContent !== step.footer.text) {
                    flagText.textContent = step.footer.text;
                }
            } else if (flagText) {
                flagText.remove();
            }
        }
    }

    /**
     * Caches DOM references for an action element.
     * @private
     * @param {HTMLElement} element - Action element.
     * @returns {Object} Cached DOM references.
     */
    #cacheDomReferences(element) {
        const task = element.querySelector('.tutorial-task');
        return {
            task,
            taskIcon: task?.querySelector('.task-icon img'),
            titleAction: task?.querySelector('.title-action'),
            subTitleAction: task?.querySelector('.sub-title-action'),
            animal: task?.querySelector('.tutorial-animal'),
            actionWrapper: element.querySelector('.tutorial-action-wrapper'),
            textElement: element.querySelector('.tutorial-action-wrapper .tutorial-text'),
            footprint: element.querySelector('.tutorial-action-footprint, .tutorial-flag-end'),
        };
    }

    /**
     * Sends a postMessage to the parent context.
     * @private
     * @param {string} type - Message type.
     * @param {Object} data - Message data.
     */
    postMessage(type, data) {
        if (typeof type !== 'string' || !type.trim()) {
            console.error('Message type must be a non-empty string');
            return;
        }

        try {
            const message = JSON.stringify(data);
            if ('webkit' in window && window.webkit.messageHandlers[type]) {
                window.webkit.messageHandlers[type].postMessage(message);
            } else if ('android' in window && (window.android || window.Android)[type]) {
                (window.android || window.Android)[type](message);
            } else {
                console.warn(`No valid message handler found for type: ${type}`);
            }
        } catch (error) {
            console.error(`Failed to send message of type "${type}":`, error);
        }
    }

    /**
     * Validates an action object.
     * @private
     * @param {Object} action - Action to validate.
     * @returns {boolean} Whether the action is valid.
     */
    #isValidAction(action) {
        return action && typeof action === 'object' && action.id && action.title;
    }

    /**
     * Converts physical pixels to viewport height (vh).
     * @private
     * @param {number} physicalPixels - Physical pixels.
     * @param {string} resolution - Resolution in "widthxheight" format.
     * @param {number} [dpr=3] - Device pixel ratio.
     * @returns {number} Viewport height value.
     */
    #convertPhysicalPixelsToVh(physicalPixels, resolution, dpr = 3) {
        if (typeof physicalPixels !== 'number' || physicalPixels < 0) {
            throw new Error('Physical pixels must be a non-negative number');
        }
        if (typeof resolution !== 'string' || !/^\d+x\d+$/.test(resolution)) {
            throw new Error('Resolution must be in "widthxheight" format');
        }

        const [, physicalHeight] = resolution.split('x').map(Number);
        const viewportHeight = physicalHeight / dpr;
        const cssPixels = physicalPixels / dpr;
        return Number(((cssPixels / viewportHeight) * 100).toFixed(2));
    }

    /**
     * Creates the main container for the tutorial.
     * @private
     */
    #createContainer() {
        if (this.#type.toLowerCase() === 'ios' && this.#heightTopLayout && this.#resolution) {
            const heightTopLayout = this.#convertPhysicalPixelsToVh(this.#heightTopLayout, this.#resolution, window.devicePixelRatio || 3);
            console.log(this.#heightTopLayout);
            document.body.style.setProperty('--height-top-layout', `${heightTopLayout}vh`);
        }
        document.body.classList.add( 
                this.#type.toLowerCase() === 'ios' ? 'use-ios' : 'use-android')
        document.body.style.setProperty('--bg-body', this.#course.bg_color || '#ffffff');
        document.body.style.setProperty('--pb-body', this.#padding_bottom ? '10px' : '0' );

        this.#container = createElement('div', {
            className: 'tutorial'
        });
        document.body.appendChild(this.#container);
    }

    /**
     * Initializes the UI structure.
     * @private
     */
    #initializeUI() {
        this.#domReferences.wrapperInner = createElement('div', { className: 'tutorial-wrapper-inner' });
        this.#domReferences.wrapper = createElement('div', { className: 'tutorial-wrapper' });

        this.#steps.forEach((step, index) => {
            const actionElement = this.#createActionElement(step, index);
            this.#domReferences.actionElements.set(step.action.actionId, actionElement);
            this.#domReferences.wrapper.appendChild(actionElement);
        });

        this.#domReferences.firstImg = this.#createDecorativeImage('first', `${this.#course.illus_assets}${this.#course.illustration}/items/${this.#animal_icons[0]}.png`);
        this.#domReferences.secondImg = this.#createDecorativeImage('second', `${this.#course.illus_assets}${this.#course.illustration}/items/${this.#animal_icons[1]}.png`);

        this.#domReferences.wrapperInner.append(
            this.#domReferences.wrapper,
            this.#domReferences.firstImg,
            this.#domReferences.secondImg
        );

        this.#container.appendChild(this.#domReferences.wrapperInner);
    }

    /**
     * Creates an action element for a step.
     * @private
     * @param {Object} step - Step configuration.
     * @param {number} index - Step index.
     * @returns {HTMLElement} Action element.
     */
    #createActionElement(step, index) {
        try {
            const action = createElement('div', { className: step.className, 'data-total-action': this.#actions.length, });
            const actionWrapper = createElement('div', { className: 'tutorial-action-wrapper' });

            if(step.includeTask) {
                actionWrapper.appendChild(this.#createActionLabel(step.action, step.isFirst));
            }

            if (step.text) {
                actionWrapper.appendChild(createElement('div', {
                    className: 'tutorial-text',
                    textContent: step.text
                }));
            }
            action.append(actionWrapper, this.#createFootPrint(step, index));
            return action;
        } catch (error) {
            console.error(`Error creating action element for actionId: ${step.action.actionId}`, error);
            throw error;
        }
    }

    /**
     * Creates an action label element.
     * @private
     * @param {Object} action - Action data.
     * @param {boolean} isFirst - Whether this is the first action.
     * @returns {HTMLElement} Action label element.
     */
    #createActionLabel(action, isFirst) {
        console.log(action)
        const actionItem = createElement('div', {
            //className: 'tutorial-task',
            className: `tutorial-task ${isFirst ? 'tutorial-task--first' : ''}`,
            events: { click: () => this.#evtHandleAction(action.actionId) },
        });
        actionItem.style.setProperty('--bg-action', action.bg_color ?? '#FFFFFF');

        actionItem.append(
            this.#createAnimalElement(action.animal, action.animalVisible),
            this.#createCheckmarkElement(isFirst),
            this.#createTaskInnerElement(action.icon, action.title, action.sub_title)
        );
        return actionItem;
    }

    /**
     * Creates an animal element.
     * @private
     * @param {string} animalSrc - Source URL for animal image.
     * @param {boolean} isVisible - Whether the animal is visible.
     * @returns {HTMLElement} Animal element.
     */
    #createAnimalElement(animalSrc, isVisible) {
        const animalDiv = createElement('div', {
            className: 'tutorial-animal',
            'data-total-action': this.#actions.length,
            style: { display: isVisible ? 'flex' : 'none' }
        });
        animalDiv.appendChild(this.#createImage(animalSrc));
        return animalDiv;
    }

    /**
     * Creates inner task element with icon and text.
     * @private
     * @param {string} icon - Icon URL.
     * @param {string} title - Action title.
     * @param {string} sub_title - Action subtitle.
     * @returns {HTMLElement} Task inner element.
     */
    #createTaskInnerElement(icon, title, sub_title) {
        const inner = createElement('div', { className: 'tutorial-task-inner' });

        if (icon) {
            const iconDiv = createElement('div', { className: 'task-icon' });
            iconDiv.appendChild(this.#createImage(icon));
            inner.appendChild(iconDiv);
        }

        const taskContentDiv = createElement('div', { className: 'task-content' });
        taskContentDiv.append(
            createElement('small', { className: 'sub-title-action', innerHTML: sub_title ?? '' }),
            createElement('span', { className: 'title-action', innerHTML: title })
        );

        inner.appendChild(taskContentDiv);
        return inner;
    }

    /**
     * Creates a checkmark element.
     * @private
     * @param {boolean} isFirst - Whether this is the first action.
     * @returns {HTMLElement} Checkmark element.
     */
    #createCheckmarkElement(isFirst) {
        const checkmark = createElement('div', { className: 'checkmark-finished' });
        const checkmarkInner = createElement('div', { className: 'checkmark-inner' });
        const txtCheckMark = createElement('span', { textContent: 'Complete!' });

        checkmarkInner.append(
            this.#createImage(`${this.#course.illus_assets}icon-default/checkmark-finished.png`),
            !isFirst ? txtCheckMark : ''
        );
        checkmark.appendChild(checkmarkInner);
        return checkmark;
    }

    /**
     * Creates a decorative image element.
     * @private
     * @param {string} position - Position of the image ('first' or 'second').
     * @param {string} src - Image source URL.
     * @returns {HTMLElement} Decorative image element.
     */
    #createDecorativeImage(position, src) {
        const container = createElement('div', {
            className: `decorative-image decorative-image--${position}`,
            'data-total-action': this.#actions.length
        });
        container.appendChild(this.#createImage(src));
        return container;
    }

    /**
     * Creates a footprint or flag element for a step.
     * @private
     * @param {Object} step - Step configuration.
     * @param {number} index - Step index.
     * @returns {HTMLElement} Footprint or flag element.
     */
    #createFootPrint({ footer, completed }, index) {
        return footer.type === 'footprint'
            ? this.#createFootprintElement(footer, completed, index)
            : this.#createFlagElement(footer);
    }

    /**
     * Creates a footprint element.
     * @private
     * @param {Object} footer - Footer configuration.
     * @param {boolean} completed - Whether the step is completed.
     * @param {number} index - Step index.
     * @returns {HTMLElement} Footprint element.
     */
    #createFootprintElement(footer, completed, index) {
        const { className, foot } = footer;
        const footprint = createElement('div', {
            className: `tutorial-action-footprint ${className}`,
            'data-total-action': this.#actions.length
        });

        const inner = createElement('div', {
            className: `tutorial-action-footprint-inner ${completed ? 'finished' : 'unfinished'} direction-${foot.direction}`
        });

        for (let i = 0; i < foot.count; i++) {
            inner.appendChild(this.#createImage(foot.src));
        }

        footprint.appendChild(inner);
        return footprint;
    }

    /**
     * Creates a flag element.
     * @private
     * @param {Object} footer - Footer configuration.
     * @returns {HTMLElement} Flag element.
     */
    #createFlagElement({ src, text }) {
        const flag = createElement('div', { className: 'tutorial-flag-end' });
        const imgFlag = createElement('div', { className: 'img-flag' });
        imgFlag.appendChild(this.#createImage(src));
        flag.append(
            imgFlag,
            createElement('div', { className: 'tutorial-text', textContent: text })
        );
        return flag;
    }

    /**
     * Creates an image element.
     * @private
     * @param {string} src - Image source URL.
     * @returns {HTMLElement} Image element.
     */
    #createImage(src) {
        return createElement('img', { src, alt: '' });
    }

    /**
     * Checks if previous actions are completed.
     * @private
     * @param {number} actionIndex - Index of the action to check.
     * @returns {boolean} Whether previous actions are completed.
     */
    #isPreviousComplete(actionIndex) {
        return this.#actions.slice(0, actionIndex).every(action => action.finished || action.is_dummy);
    }

    /**
     * Handles action click events.
     * @private
     * @param {string} actionId - ID of the action.
     */
    #evtHandleAction(actionId) {
        const actionIndex = this.#actions.findIndex(a => a.internalId === actionId);
        if (actionIndex === -1 || this.#actions[actionIndex].is_dummy) return;
        const action = this.#actions[actionIndex];
        this.postMessage('openTask', {
            actionId: action.id,
            is_first_action: action.is_first_action ?? false,
            isValid: this.#isPreviousComplete(actionIndex)
        });
    }

    /**
     * Renders the tutorial UI.
     * @private
     * @param {boolean} courseChanged - Whether course data changed.
     * @param {Object} actionsChangedInfo - Action change information.
     */
    #render(courseChanged, actionsChangedInfo) {
        if (!this.#container) {
            this.#createContainer();
            this.#initializeUI();
        } else if (courseChanged || actionsChangedInfo.changed) {
            this.#updateUI(courseChanged, actionsChangedInfo);
        }
    }
}

const tutorial = new Tutorial();

/**
 * Initializes the tutorial app with provided data.
 * @param {Object|string} data - Initial data or JSON string.
 * @returns {boolean} Whether initialization was successful.
 */
window.initTutorialApp = function (data) {
    let error = null;
    let isSuccess = false;
    try {
        tutorial.init(data);
        isSuccess = true;
    } catch (err) {
        error = err.message;
    }
    tutorial.postMessage('loadFinished', { error, success: isSuccess });
    return isSuccess;
};

tutorial.postMessage('javascriptLoaded', { success: true });


})();
    </script>
  </body>
</html>